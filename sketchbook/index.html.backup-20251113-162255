<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sketchbook</title>
	<link href="build/style.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
        }

        /* Mobile Icon Buttons */
        .mobile-icon-button {
            position: fixed;
            top: 15px;
            width: 50px;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10000;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .mobile-icon-button:active {
            background-color: rgba(0, 0, 0, 0.9);
            transform: scale(0.95);
        }

        .mobile-icon-button svg {
            width: 28px;
            height: 28px;
            fill: white;
        }

        #mobile-settings-icon {
            left: 15px;
        }

        #player-editor-icon {
            left: 75px;
        }

        /* Player Editor GUI Panel */
        #player-editor-panel {
            position: fixed;
            top: 80px;
            left: 15px;
            background-color: rgba(0, 0, 0, 0.9);
            border-radius: 8px;
            padding: 15px;
            width: 280px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            z-index: 9999;
            display: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
        }

        #player-editor-panel.visible {
            display: block;
        }

        #player-editor-panel h3 {
            margin: 0 0 15px 0;
            color: white;
            font-family: 'Solway', sans-serif;
            font-size: 18px;
            text-align: center;
        }

        .slider-container {
            margin-bottom: 15px;
        }

        .slider-container label {
            color: white;
            font-family: 'Solway', sans-serif;
            font-size: 13px;
            display: block;
            margin-bottom: 5px;
        }

        .slider-container input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }

        .slider-container input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            color: #4CAF50;
            font-family: 'Cutive Mono', monospace;
            font-size: 12px;
            float: right;
        }

        /* FPS Counter */
        #fps-counter {
            position: fixed;
            top: 15px;
            right: 75px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #4CAF50;
            font-family: 'Cutive Mono', monospace;
            font-size: 14px;
            padding: 6px 10px;
            border-radius: 4px;
            z-index: 10000;
            pointer-events: none;
        }

        /* Vehicle Enter/Exit Button */
        #vehicle-button {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 50px;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10000;
            transition: background-color 0.2s;
        }

        #vehicle-button:active {
            background-color: rgba(0, 0, 0, 0.9);
        }

        #vehicle-button svg {
            width: 30px;
            height: 30px;
            fill: white;
        }

        .vehicle-icon {
            display: none;
        }

        .vehicle-icon.active {
            display: block;
        }

        /* Hide UI panels by default on mobile */
        .left-panel,
        .dg.main {
            display: none !important;
        }

        /* Show UI panels when toggled */
        body.ui-visible .left-panel,
        body.ui-visible .dg.main {
            display: flex !important;
        }

        /* Make panels scrollable on mobile */
        body.ui-visible .left-panel {
            max-height: 80vh;
            overflow-y: auto;
        }

        body.ui-visible .dg.main {
            background-color: rgba(0, 0, 0, 0.85);
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Hide GitHub corner on mobile */
        .github-corner {
            display: none !important;
        }

        /* Hide overlay - no screen dimming needed */
        #ui-overlay {
            display: none !important;
        }
    </style>
</head>

<body>
    <!-- Mobile Settings Icon -->
    <div id="mobile-settings-icon" class="mobile-icon-button">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
        </svg>
    </div>

    <!-- Player Editor Icon -->
    <div id="player-editor-icon" class="mobile-icon-button">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
    </div>

    <!-- Player Editor Panel -->
    <div id="player-editor-panel">
        <h3>Player Editor</h3>
        <div class="slider-container">
            <label>Scale <span class="slider-value" id="scale-value">1.0</span></label>
            <input type="range" id="scale-slider" min="0.5" max="3.0" step="0.1" value="1.0">
        </div>
        <div class="slider-container">
            <label>Movement Speed <span class="slider-value" id="movespeed-value">4.0</span></label>
            <input type="range" id="movespeed-slider" min="1.0" max="16.0" step="0.5" value="4.0">
        </div>
        <div class="slider-container">
            <label>Jump Power <span class="slider-value" id="jumppower-value">8.0</span></label>
            <input type="range" id="jumppower-slider" min="2.0" max="20.0" step="0.5" value="8.0">
        </div>
        <div class="slider-container">
            <label>Gravity <span class="slider-value" id="gravity-value">-9.81</span></label>
            <input type="range" id="gravity-slider" min="-20" max="-5" step="0.5" value="-9.81">
        </div>
    </div>

    <!-- Overlay for closing UI -->
    <div id="ui-overlay"></div>

    <!-- FPS Counter -->
    <div id="fps-counter">FPS: 0</div>

    <!-- Vehicle Enter/Exit Button -->
    <div id="vehicle-button" class="mobile-icon-button">
        <!-- Car icon (shown when NOT in vehicle - click to enter) -->
        <svg class="vehicle-icon car-icon active" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
        </svg>
        <!-- Character icon (shown when IN vehicle - click to exit) -->
        <svg class="vehicle-icon character-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
    </div>

    <div id="loading-screen">
		<div id="loading-screen-background"></div>
		<h1 id="main-title" class="sb-font">Sketchbook 0.4</h1>
		<div class="cubeWrap">
			<div class="cube">
				<div class="faces1"></div>
				<div class="faces2"></div>
			</div>
		</div>
		<div id="loading-text">Loading...</div>
    </div>

    <div id="ui-container" style="display: none;">
        <div class="github-corner"><a href="https://github.com/swift502/Sketchbook" target="_blank" title="Fork me on GitHub"><svg viewbox="0 0 100 100" fill="currentColor"><title>Fork me on GitHub</title><path d="M0 0v100h100V0H0zm60 70.2h.2c1 2.7.3 4.7 0 5.2 1.4 1.4 2 3 2 5.2 0 7.4-4.4 9-8.7 9.5.7.7 1.3 2 1.3 3.7V99c0 .5 1.4 1 1.4 1H44s1.2-.5 1.2-1v-3.8c-3.5 1.4-5.2-.8-5.2-.8-1.5-2-3-2-3-2-2-.5-.2-1-.2-1 2-.7 3.5.8 3.5.8 2 1.7 4 1 5 .3.2-1.2.7-2 1.2-2.4-4.3-.4-8.8-2-8.8-9.4 0-2 .7-4 2-5.2-.2-.5-1-2.5.2-5 0 0 1.5-.6 5.2 1.8 1.5-.4 3.2-.6 4.8-.6 1.6 0 3.3.2 4.8.7 2.8-2 4.4-2 5-2z"></path></svg></a></div>
        <div class="left-panel">
            <div id="controls" class="panel-segment flex-bottom"></div>
        </div>
    </div>

    <script src="build/sketchbook.min.js"></script>
    <script>
        let world = new Sketchbook.World('build/assets/world.glb');

        // Disable pointer lock for mobile
        world.params.Pointer_Lock = false;
        world.inputManager.setPointerLock(false);

        // GLOBAL keyboard event emulation - accessible by touch controls AND buttons
        function dispatchKey(code, pressed) {
            const event = new KeyboardEvent(pressed ? 'keydown' : 'keyup', {
                code: code,
                key: code,
                bubbles: true,
                cancelable: true
            });
            document.dispatchEvent(event);
        }

        // Mobile Touch Controls
        (function() {
            const touches = {};
            let activeKeys = new Set();
            let leftTouch = null;
            let rightTouch = null;
            let cameraRotation = { x: 0, y: 0 };

            // Vehicle bunny hop mechanics
            let lastTapTime = 0;
            let chargeStartTime = 0;
            let isCharging = false;
            const DOUBLE_TAP_THRESHOLD = 300; // ms between taps to count as double tap
            const MIN_CHARGE_POWER = 5;       // Minimum jump power (quick tap)
            const MAX_CHARGE_POWER = 25;      // Maximum jump power (full charge)
            const MAX_CHARGE_TIME = 2000;     // Max charge time in ms (2 seconds)

            function setKey(code, pressed) {
                if (pressed && !activeKeys.has(code)) {
                    activeKeys.add(code);
                    dispatchKey(code, true);
                } else if (!pressed && activeKeys.has(code)) {
                    activeKeys.delete(code);
                    dispatchKey(code, false);
                }
            }

            function clearAllKeys() {
                activeKeys.forEach(code => dispatchKey(code, false));
                activeKeys.clear();
            }

            // Apply bunny hop to vehicle
            function applyVehicleJump(power) {
                if (world && world.characters && world.characters.length > 0) {
                    const player = world.characters[0];
                    if (player.occupyingSeat) {
                        // Player is in a vehicle
                        const vehicle = player.occupyingSeat.vehicle;
                        if (vehicle && vehicle.rayCastVehicle && vehicle.rayCastVehicle.chassisBody) {
                            const body = vehicle.rayCastVehicle.chassisBody;
                            // Apply upward impulse for bunny hop
                            body.velocity.y += power;
                        }
                    }
                }
            }

            // Continuous camera rotation loop
            function updateCamera() {
                if (rightTouch !== null && (Math.abs(cameraRotation.x) > 0.01 || Math.abs(cameraRotation.y) > 0.01)) {
                    if (world && world.cameraOperator) {
                        world.cameraOperator.move(cameraRotation.x, cameraRotation.y);
                    }
                }
                requestAnimationFrame(updateCamera);
            }
            updateCamera();

            document.addEventListener('touchstart', function(e) {
                const target = e.target;
                if (target && (target.closest('.swal2-container') || target.closest('#ui-container') || target.closest('.mobile-icon-button') || target.closest('#player-editor-panel'))) {
                    return;
                }
                e.preventDefault();

                for (let i = 0; i < e.changedTouches.length; i++) {
                    const touch = e.changedTouches[i];
                    const x = touch.clientX;
                    const y = touch.clientY;
                    const screenWidth = window.innerWidth;
                    const side = x < screenWidth / 2 ? 'left' : 'right';

                    touches[touch.identifier] = {
                        startX: x,
                        startY: y,
                        currentX: x,
                        currentY: y,
                        startTime: Date.now(),
                        side: side
                    };

                    if (side === 'left') {
                        leftTouch = touch.identifier;
                    } else if (side === 'right') {
                        rightTouch = touch.identifier;
                    }
                }
            }, { passive: false });

            document.addEventListener('touchmove', function(e) {
                const target = e.target;
                if (target && (target.closest('.swal2-container') || target.closest('#ui-container') || target.closest('.mobile-icon-button') || target.closest('#player-editor-panel'))) {
                    return;
                }
                e.preventDefault();

                for (let i = 0; i < e.changedTouches.length; i++) {
                    const touch = e.changedTouches[i];
                    const t = touches[touch.identifier];
                    if (!t) continue;

                    t.currentX = touch.clientX;
                    t.currentY = touch.clientY;

                    if (t.side === 'left' && touch.identifier === leftTouch) {
                        // Left joystick: WASD movement
                        const dx = t.currentX - t.startX;
                        const dy = t.currentY - t.startY;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        const threshold = 30;
                        const sprintThreshold = 100;

                        setKey('KeyW', dy < -threshold);
                        setKey('KeyS', dy > threshold);
                        setKey('KeyA', dx < -threshold);
                        setKey('KeyD', dx > threshold);
                        setKey('ShiftLeft', distance > sprintThreshold);
                    } else if (t.side === 'right' && touch.identifier === rightTouch) {
                        // Right joystick: continuous camera rotation based on displacement from center
                        const dx = t.currentX - t.startX;
                        const dy = t.currentY - t.startY;
                        const deadzone = 20;

                        // Apply deadzone
                        if (Math.abs(dx) > deadzone || Math.abs(dy) > deadzone) {
                            // Rotation speed based on distance from center
                            const sensitivity = 0.15;
                            cameraRotation.x = dx * sensitivity;
                            cameraRotation.y = dy * sensitivity;
                        } else {
                            cameraRotation.x = 0;
                            cameraRotation.y = 0;
                        }
                    }
                }
            }, { passive: false });

            document.addEventListener('touchend', function(e) {
                const target = e.target;
                if (target && (target.closest('.swal2-container') || target.closest('#ui-container') || target.closest('.mobile-icon-button') || target.closest('#player-editor-panel'))) {
                    return;
                }
                e.preventDefault();

                for (let i = 0; i < e.changedTouches.length; i++) {
                    const touch = e.changedTouches[i];
                    const t = touches[touch.identifier];
                    if (!t) continue;

                    const duration = Date.now() - t.startTime;
                    const dx = t.currentX - t.startX;
                    const dy = t.currentY - t.startY;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    // Right side tap handling
                    if (t.side === 'right' && distance < 40) {
                        const now = Date.now();
                        const isInVehicle = world && world.characters && world.characters.length > 0 &&
                                          world.characters[0].occupyingSeat !== null;

                        if (isInVehicle) {
                            // VEHICLE BUNNY HOP MECHANICS
                            if (isCharging) {
                                // Release charged jump
                                const chargeTime = Math.min(now - chargeStartTime, MAX_CHARGE_TIME);
                                const chargeRatio = chargeTime / MAX_CHARGE_TIME;
                                const jumpPower = MIN_CHARGE_POWER + (chargeRatio * (MAX_CHARGE_POWER - MIN_CHARGE_POWER));
                                applyVehicleJump(jumpPower);
                                isCharging = false;
                                chargeStartTime = 0;
                            } else if (duration < 300) {
                                // Quick tap - check for double tap
                                if (now - lastTapTime < DOUBLE_TAP_THRESHOLD) {
                                    // Double tap detected - start charging
                                    isCharging = true;
                                    chargeStartTime = now;
                                } else {
                                    // Single tap - quick bunny hop
                                    applyVehicleJump(MIN_CHARGE_POWER);
                                }
                                lastTapTime = now;
                            }
                        } else {
                            // CHARACTER JUMP (not in vehicle)
                            if (duration < 300) {
                                dispatchKey('Space', true);
                                setTimeout(() => dispatchKey('Space', false), 50);
                            }
                        }
                    }

                    // Release movement keys for left touch
                    if (t.side === 'left' && touch.identifier === leftTouch) {
                        setKey('KeyW', false);
                        setKey('KeyS', false);
                        setKey('KeyA', false);
                        setKey('KeyD', false);
                        setKey('ShiftLeft', false);
                        leftTouch = null;
                    }

                    if (t.side === 'right' && touch.identifier === rightTouch) {
                        cameraRotation.x = 0;
                        cameraRotation.y = 0;
                        rightTouch = null;
                    }

                    delete touches[touch.identifier];
                }
            }, { passive: false });

            document.addEventListener('touchcancel', function(e) {
                clearAllKeys();
                cameraRotation.x = 0;
                cameraRotation.y = 0;
                leftTouch = null;
                rightTouch = null;
                isCharging = false;
                chargeStartTime = 0;
                for (let i = 0; i < e.changedTouches.length; i++) {
                    delete touches[e.changedTouches[i].identifier];
                }
            }, { passive: true });
        })();

        // Mobile UI Toggle
        document.addEventListener('DOMContentLoaded', function() {
            const settingsIcon = document.getElementById('mobile-settings-icon');

            function toggleUI() {
                document.body.classList.toggle('ui-visible');
            }

            function hideUI() {
                document.body.classList.remove('ui-visible');
            }

            if (settingsIcon) {
                settingsIcon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleUI();
                });
            }

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.body.classList.contains('ui-visible')) {
                    hideUI();
                }
            });

            // Player Editor functionality
            const playerEditorIcon = document.getElementById('player-editor-icon');
            const playerEditorPanel = document.getElementById('player-editor-panel');

            if (playerEditorIcon && playerEditorPanel) {
                playerEditorIcon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    playerEditorPanel.classList.toggle('visible');
                });

                // Close panel when clicking outside
                document.addEventListener('click', function(e) {
                    if (!playerEditorPanel.contains(e.target) && e.target !== playerEditorIcon && !playerEditorIcon.contains(e.target)) {
                        playerEditorPanel.classList.remove('visible');
                    }
                });

                // Vehicle Enter/Exit Button
                const vehicleButton = document.getElementById('vehicle-button');
                const carIcon = document.querySelector('.car-icon');
                const characterIcon = document.querySelector('.character-icon');

                vehicleButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    // Press F key to enter/exit vehicle (driver seat)
                    dispatchKey('KeyF', true);
                    setTimeout(() => dispatchKey('KeyF', false), 50);
                });

                // Store base physics values for scale calculations
                const basePhysicsProps = {
                    capsuleHeight: 0.5,
                    capsuleRadius: 0.25,
                    raycastLength: 0.57
                };

                // Custom jump power value
                let customJumpPower = 8.0;  // Default vertical jump velocity (2x game default)

                // Custom gravity value - continuously enforced
                let customGravity = -9.81;  // Default gravity

                // Jump boost tracking
                let lastBoostTime = 0;
                let previousVelocityY = 0;

                // FPS tracking
                let lastFrameTime = performance.now();
                let frameCount = 0;
                let fps = 0;
                const fpsCounter = document.getElementById('fps-counter');

                // Slider handlers - SIMPLE DIRECT ASSIGNMENTS
                const sliders = {
                    scale: {
                        slider: document.getElementById('scale-slider'),
                        value: document.getElementById('scale-value'),
                        apply: (val) => {
                            if (world && world.characters && world.characters.length > 0) {
                                world.characters.forEach(char => {
                                    // Apply visual scale
                                    char.scale.set(val, val, val);

                                    // Scale physics capsule proportionally
                                    if (char.characterCapsule && char.characterCapsule.body) {
                                        const scaledHeight = basePhysicsProps.capsuleHeight * val;
                                        const scaledRadius = basePhysicsProps.capsuleRadius * val;

                                        // Update capsule shapes (cylinder + 2 spheres)
                                        char.characterCapsule.body.shapes.forEach((shape, index) => {
                                            if (index === 0) {
                                                shape.height = scaledHeight;
                                                shape.radius = scaledRadius;
                                            } else {
                                                shape.radius = scaledRadius;
                                            }
                                        });

                                        // Update shape offsets for top/bottom spheres
                                        const halfHeight = scaledHeight / 2;
                                        if (char.characterCapsule.body.shapeOffsets[1]) {
                                            char.characterCapsule.body.shapeOffsets[1].y = halfHeight;
                                        }
                                        if (char.characterCapsule.body.shapeOffsets[2]) {
                                            char.characterCapsule.body.shapeOffsets[2].y = -halfHeight;
                                        }

                                        // Update AABB
                                        char.characterCapsule.body.updateBoundingRadius();
                                        char.characterCapsule.body.aabbNeedsUpdate = true;
                                    }

                                    // Scale raycast length for ground detection
                                    char.rayCastLength = basePhysicsProps.raycastLength * val;
                                });
                            }
                        }
                    },
                    movespeed: {
                        slider: document.getElementById('movespeed-slider'),
                        value: document.getElementById('movespeed-value'),
                        apply: (val) => {
                            if (world && world.characters && world.characters.length > 0) {
                                world.characters.forEach(char => {
                                    // DIRECT assignment to moveSpeed (movement multiplier)
                                    char.moveSpeed = val;
                                });
                            }
                        }
                    },
                    jumppower: {
                        slider: document.getElementById('jumppower-slider'),
                        value: document.getElementById('jumppower-value'),
                        apply: (val) => {
                            // Store custom jump power - will be used by detection system
                            customJumpPower = val;
                        }
                    },
                    gravity: {
                        slider: document.getElementById('gravity-slider'),
                        value: document.getElementById('gravity-value'),
                        apply: (val) => {
                            // Store custom gravity value
                            customGravity = val;
                            if (world && world.physicsWorld) {
                                world.physicsWorld.gravity.set(0, val, 0);
                            }
                        }
                    }
                };

                // Setup all sliders
                Object.keys(sliders).forEach(key => {
                    const config = sliders[key];
                    if (config.slider && config.value) {
                        config.slider.addEventListener('input', function(e) {
                            const val = parseFloat(e.target.value);
                            config.value.textContent = val.toFixed(2);
                            config.apply(val);
                        });
                    }
                });

                // Jump boost + gravity enforcement + FPS tracking + vehicle icon toggle
                function applyCustomSettings() {
                    // FPS calculation
                    const currentTime = performance.now();
                    frameCount++;
                    if (currentTime - lastFrameTime >= 1000) {
                        fps = Math.round(frameCount * 1000 / (currentTime - lastFrameTime));
                        if (fpsCounter) fpsCounter.textContent = `FPS: ${fps}`;
                        frameCount = 0;
                        lastFrameTime = currentTime;
                    }

                    if (world && world.characters && world.characters.length > 0) {
                        const now = Date.now();
                        const player = world.characters[0]; // Main player character

                        // Toggle vehicle button icon based on whether player is in vehicle
                        if (player) {
                            const isInVehicle = player.occupyingSeat !== null && player.occupyingSeat !== undefined;

                            if (isInVehicle) {
                                // In vehicle: show character icon (exit)
                                carIcon.classList.remove('active');
                                characterIcon.classList.add('active');
                            } else {
                                // Not in vehicle: show car icon (enter)
                                carIcon.classList.add('active');
                                characterIcon.classList.remove('active');
                            }
                        }

                        world.characters.forEach(char => {
                            if (char.characterCapsule && char.characterCapsule.body) {
                                const body = char.characterCapsule.body;
                                const currentVelY = body.velocity.y;

                                // PRECISE detection: velocity just increased by ~4 (game's jump boost)
                                const velocityIncrease = currentVelY - previousVelocityY;

                                // Only boost if velocity increased by approximately 4 AND cooldown passed
                                if (velocityIncrease >= 3.8 && velocityIncrease <= 4.2 && (now - lastBoostTime) > 150) {
                                    // Replace game's +4 with custom jump power
                                    body.velocity.y = previousVelocityY + customJumpPower;
                                    lastBoostTime = now;
                                }

                                // Track velocity for next frame
                                previousVelocityY = body.velocity.y;
                            }
                        });

                        // Continuously enforce custom gravity (prevents any resets)
                        if (world.physicsWorld) {
                            world.physicsWorld.gravity.set(0, customGravity, 0);
                        }
                    }
                    requestAnimationFrame(applyCustomSettings);
                }
                applyCustomSettings();
            }
        });
    </script>
</body>
</html>
